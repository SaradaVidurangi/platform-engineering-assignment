image: docker:latest

services:
  - docker:dind

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_TLS_CERTDIR: ""
  AWS_REGION: "us-east-1"
  ECR_REGISTRY: "967823535579.dkr.ecr.us-east-1.amazonaws.com"
  ECR_REPOSITORY: "my-java-app"
  IMAGE_TAG: "latest"

stages:
  - build
  - deploy

build:
  image: maven:3.9-eclipse-temurin-17
  stage: build
  script:
    - echo "Building JAR..."
    - ./mvnw clean package -DskipTests
    - echo "Building Docker image..."
    - docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
    - docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - echo "Logging in to AWS ECR..."
    - aws --version
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
    - echo "Pushing image to AWS ECR..."
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

deploy:
  image: amazon/aws-cli:2
  stage: deploy
  script:
    - echo "Deploying to ECS..."
    - aws ecs update-service \
        --cluster my-java-app-cluster \
        --service my-java-app-service \
        --force-new-deployment \
        --region $AWS_REGION
